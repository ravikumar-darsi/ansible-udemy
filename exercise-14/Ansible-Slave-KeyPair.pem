ubuntu@ip-172-31-34-26:~/vprofile-practice$ cp -r exercise-13 exercise-14
ubuntu@ip-172-31-34-26:~/vprofile-practice$ cd exercise-14
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ vim provisioning.yaml
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cat provisioning.yaml
---
- name: Provisioning servers
  hosts: all
  become: yes
  vars:
    mydir: /opt/dir24
  tasks:
    - name: Install ntp agent on centos
      ansible.builtin.yum:
        name: "{{item}}"
        state: present
      when: ansible_distribution == "CentOS"
      loop:
        - chrony
        - wget
        - git
        - zip
        - unzip

    - name: Install ntp agent on Ubuntu
      ansible.builtin.apt:
        name: "{{item}}"
        state: present
        update_cache: yes
      when: ansible_distribution == "Ubuntu"
      loop:
        - ntp
        - wget
        - git
        - zip
        - unzip

    - name: Install ntp agent on Amazon
      ansible.builtin.yum:
        name: "{{item}}"
        state: present
      when: ansible_distribution == "Amazon"
      loop:
        - ntp
        - wget
        - git
        - zip
        - unzip

    - name: Start the service on Centos
      ansible.builtin.service:
        name: chronyd
        state: started
        enabled: yes
      when: ansible_distribution == "CentOS"

    - name: Start the service on Ubuntu
      ansible.builtin.service:
        name: ntp
        state: started
        enabled: yes
      when: ansible_distribution == "Ubuntu"

    - name: Start the service on Amazon
      ansible.builtin.service:
        name: ntpd
        state: started
        enabled: yes
      when: ansible_distribution == "Amazon"

    - name: Banner File
      ansible.builtin.copy:
        content: "# This sever is managed by ansible.No manual changes"
        dest: /etc/motd

    - name: Create a Folder
      ansible.builtin.file:
        path: "{{mydir}}"
        state: directory

    - name: Deploy ntp agent conf on CentOS
      template:
        src: templates/ntpconf_centos
        dest: /etc/chrony.conf
        backup: yes
      when: ansible_distribution == "CentOS"
      notify:
        - Restart the service on Centos

    - name: Deploy ntp agent conf on Ubuntu
      template:
        src: templates/ntpconf_ubuntu
        dest: /etc/ntp.conf
        backup: yes
      when: ansible_distribution == "Ubuntu"
      notify:
        - Restart the service on Ubuntu

    - name: Deploy ntp agent conf on Amazon
      template:
        src: templates/ntpconf_amazon
        dest: /etc/ntp.conf
        backup: yes
      when: ansible_distribution == "Amazon"
      notify:
        - Restart the service on Amazon

    - name: Dump a file
      ansible.builtin.copy:
        src: files/myfile.txt
        dest: /tmp/myfile.txt

  handlers:
    - name: Restart the service on Centos
      ansible.builtin.service:
        name: chronyd
        state: restarted
        enabled: yes
      when: ansible_distribution == "CentOS"

    - name: Restart the service on Ubuntu
      ansible.builtin.service:
        name: ntp
        state: restarted
        enabled: yes
      when: ansible_distribution == "Ubuntu"

    - name: Restart the service on Amazon
      ansible.builtin.service:
        name: ntpd
        state: restarted
        enabled: yes
      when: ansible_distribution == "Amazon"

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ ansible-playbook provisioning.yaml

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ sudo apt install tree -y

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cd ..
ubuntu@ip-172-31-34-26:~/vprofile-practice$ tree exercise-14
exercise-14
├── Ansible-Slave-KeyPair.pem
├── ansible.cfg
├── files
│   └── myfile.txt
├── group_vars
│   ├── all
│   └── webservers
├── host_vars
│   └── web02
├── inventory
├── provisioning.yaml
└── templates
    ├── ntpconf_amazon
    ├── ntpconf_centos
    └── ntpconf_ubuntu

ubuntu@ip-172-31-34-26:~/vprofile-practice$ cd exercise-14
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ mkdir roles
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cd roles/
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles$ ansible-galaxy init post-install
- Role post-install was created successfully
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles$ ls
post-install
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles$ tree
.
└── post-install
    ├── README.md
    ├── defaults
    │   └── main.yml
    ├── files
    ├── handlers
    │   └── main.yml
    ├── meta
    │   └── main.yml
    ├── tasks
    │   └── main.yml
    ├── templates
    ├── tests
    │   ├── inventory
    │   └── test.yml
    └── vars
        └── main.yml

9 directories, 8 files
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles$ cd ..
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cat group_vars/all
USRNM: commonuser
COMM: variable from groupvars_all file
ntp0: 0.north-america.pool.ntp.org
ntp1: 1.north-america.pool.ntp.org
ntp2: 2.north-america.pool.ntp.org
ntp3: 3.north-america.pool.ntp.org
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ vim roles/post-install/vars/main.yml
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ vim roles/post-install/vars/main.yml
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cat roles/post-install/vars/main.yml
---
# vars file for post-install
USRNM: commonuser
COMM: variable from groupvars_all file
ntp0: 0.north-america.pool.ntp.org
ntp1: 1.north-america.pool.ntp.org
ntp2: 2.north-america.pool.ntp.org
ntp3: 3.north-america.pool.ntp.org
mydir: /opt/dir24
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ rm -rf group_vars host_vars
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ ls
Ansible-Slave-KeyPair.pem  files      provisioning.yaml  templates
ansible.cfg                inventory  roles
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cp files/* roles/post-install/files/
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cp templates/* roles/post-install/templates/
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ vim roles/post-install/handlers/main.yml
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cat roles/post-install/handlers/main.yml
---
# handlers file for post-install
- name: Restart the service on Centos
  ansible.builtin.service:
    name: chronyd
    state: restarted
    enabled: yes
  when: ansible_distribution == "CentOS"

- name: Restart the service on Ubuntu
  ansible.builtin.service:
    name: ntp
    state: restarted
    enabled: yes
  when: ansible_distribution == "Ubuntu"

- name: Restart the service on Amazon
  ansible.builtin.service:
    name: ntpd
    state: restarted
    enabled: yes
  when: ansible_distribution == "Amazon"

I copied the handlers from the provisioning.yaml and make to remove the space in while copied, I used ESC mode :%s/^    //

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ vim roles/post-install/tasks/main.yml
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cat roles/post-install/tasks/main.yml
---
# tasks file for post-install
- name: Install ntp agent on centos
  ansible.builtin.yum:
    name: "{{item}}"
    state: present
  when: ansible_distribution == "CentOS"
  loop:
    - chrony
    - wget
    - git
    - zip
    - unzip

- name: Install ntp agent on Ubuntu
  ansible.builtin.apt:
    name: "{{item}}"
    state: present
    update_cache: yes
  when: ansible_distribution == "Ubuntu"
  loop:
    - ntp
    - wget
    - git
    - zip
    - unzip

- name: Install ntp agent on Amazon
  ansible.builtin.yum:
    name: "{{item}}"
    state: present
  when: ansible_distribution == "Amazon"
  loop:
    - ntp
    - wget
    - git
    - zip
    - unzip

- name: Start the service on Centos
  ansible.builtin.service:
    name: chronyd
    state: started
    enabled: yes
  when: ansible_distribution == "CentOS"

- name: Start the service on Ubuntu
  ansible.builtin.service:
    name: ntp
    state: started
    enabled: yes
  when: ansible_distribution == "Ubuntu"

- name: Start the service on Amazon
  ansible.builtin.service:
    name: ntpd
    state: started
    enabled: yes
  when: ansible_distribution == "Amazon"

- name: Banner File
  ansible.builtin.copy:
    content: "# This sever is managed by ansible.No manual changes"
    dest: /etc/motd

- name: Create a Folder
  ansible.builtin.file:
    path: "{{mydir}}"
    state: directory

- name: Deploy ntp agent conf on CentOS
  template:
    src: templates/ntpconf_centos
    dest: /etc/chrony.conf
    backup: yes
  when: ansible_distribution == "CentOS"
  notify:
    - Restart the service on Centos

- name: Deploy ntp agent conf on Ubuntu
  template:
    src: templates/ntpconf_ubuntu
    dest: /etc/ntp.conf
    backup: yes
  when: ansible_distribution == "Ubuntu"
  notify:
    - Restart the service on Ubuntu

- name: Deploy ntp agent conf on Amazon
  template:
    src: templates/ntpconf_amazon
    dest: /etc/ntp.conf
    backup: yes
  when: ansible_distribution == "Amazon"
  notify:
    - Restart the service on Amazon

- name: Dump a file
  ansible.builtin.copy:
    src: files/myfile.txt
    dest: /tmp/myfile.txt

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ vim provisioning.yaml
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cat provisioning.yaml
---
- name: Provisioning servers
  hosts: all
  become: yes
  roles:
    - post-install
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ ls
Ansible-Slave-KeyPair.pem  files      provisioning.yaml  templates
ansible.cfg                inventory  roles
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ rm -rf files templates
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ vim roles/post-install/tasks/main.yml  ( chnaged with.j2 extension )
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cat roles/post-install/tasks/main.yml
---
# tasks file for post-install
- name: Install ntp agent on centos
  ansible.builtin.yum:
    name: "{{item}}"
    state: present
  when: ansible_distribution == "CentOS"
  loop:
    - chrony
    - wget
    - git
    - zip
    - unzip

- name: Install ntp agent on Ubuntu
  ansible.builtin.apt:
    name: "{{item}}"
    state: present
    update_cache: yes
  when: ansible_distribution == "Ubuntu"
  loop:
    - ntp
    - wget
    - git
    - zip
    - unzip

- name: Install ntp agent on Amazon
  ansible.builtin.yum:
    name: "{{item}}"
    state: present
  when: ansible_distribution == "Amazon"
  loop:
    - ntp
    - wget
    - git
    - zip
    - unzip

- name: Start the service on Centos
  ansible.builtin.service:
    name: chronyd
    state: started
    enabled: yes
  when: ansible_distribution == "CentOS"

- name: Start the service on Ubuntu
  ansible.builtin.service:
    name: ntp
    state: started
    enabled: yes
  when: ansible_distribution == "Ubuntu"

- name: Start the service on Amazon
  ansible.builtin.service:
    name: ntpd
    state: started
    enabled: yes
  when: ansible_distribution == "Amazon"

- name: Banner File
  ansible.builtin.copy:
    content: "# This sever is managed by ansible.No manual changes"
    dest: /etc/motd

- name: Create a Folder
  ansible.builtin.file:
    path: "{{mydir}}"
    state: directory

- name: Deploy ntp agent conf on CentOS
  template:
    src: ntpconf_centos.j2
    dest: /etc/chrony.conf
    backup: yes
  when: ansible_distribution == "CentOS"
  notify:
    - Restart the service on Centos

- name: Deploy ntp agent conf on Ubuntu
  template:
    src: ntpconf_ubuntu.j2
    dest: /etc/ntp.conf
    backup: yes
  when: ansible_distribution == "Ubuntu"
  notify:
    - Restart the service on Ubuntu

- name: Deploy ntp agent conf on Amazon
  template:
    src: ntpconf_amazon.j2 # recommended way of .j2 extension
    dest: /etc/ntp.conf
    backup: yes
  when: ansible_distribution == "Amazon"
  notify:
    - Restart the service on Amazon

- name: Dump a file
  ansible.builtin.copy:
    src: myfile.txt
    dest: /tmp/myfile.txt

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14$ cd roles/post-install/templates/
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles/post-install/templates$ ls
ntpconf_amazon  ntpconf_centos  ntpconf_ubuntu
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles/post-install/templates$ mv ntpconf_centos ntpconf_centos.j2
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles/post-install/templates$ ls
ntpconf_amazon  ntpconf_centos.j2  ntpconf_ubuntu
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles/post-install/templates$ mv ntpconf_amazon ntpconf_amazon.j2
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles/post-install/templates$ mv ntpconf_ubuntu ntpconf_ubuntu.j2
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-14/roles/post-install/templates$







