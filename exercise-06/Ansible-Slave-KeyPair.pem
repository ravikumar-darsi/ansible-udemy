cp -r exercise-05 exercise-07

vim db.yaml
---
- name: DBServers-Setup
  hosts: dbservers
  become: yes
  tasks:
    - name: Install mariadb-server
      ansible.builtin.yum:
        name: mariadb-server
        state: present
    - name: Start the mariaDB-server
      ansible.builtin.service:
        name: mariadb
        state: started
        enabled: yes
    - name: Create a new Database with name 'accounts'
      mysql_db:
        name: accounts
        state: present

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-07$ ansible-playbook -i inventory db.yaml

PLAY [DBServers-Setup] *****************************************************************************************************************************************************************

TASK [Gathering Facts] *****************************************************************************************************************************************************************
ok: [db01]

TASK [Install mariadb-server] **********************************************************************************************************************************************************
ok: [db01]

TASK [Start the mariaDB-server] ********************************************************************************************************************************************************
ok: [db01]

TASK [Create a new Database with name 'accounts'] **************************************************************************************************************************************
fatal: [db01]: FAILED! => {"changed": false, "msg": "A MySQL module is required: for Python 2.7 either PyMySQL, or MySQL-python, or for Python 3.X mysqlclient or PyMySQL. Consider setting ansible_python_interpreter to use the intended Python version."}

PLAY RECAP *****************************************************************************************************************************************************************************
db01                       : ok=3    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0

Why it failed? There are many modules that required dependencies and these dependencies are mostly
the python dependencies. Now, what exactly is happening here?
We Know Ansiblw creates Python scripts. It will dump in the destination, which is db01 in this case(if any doubt check inventory file)
at the remote location and executes those python scripts. Those python scripts will need Python dependency for certain module.
For example, a MySQl module is required for Python 2.7


ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-07$ ssh -i Ansible-Slave-KeyPair.pem ec2-user@172.31.37.52
Last login: Wed Aug 14 10:46:54 2024 from 172.31.34.26
[ec2-user@ip-172-31-37-52 ~]$ sudo -i
[root@ip-172-31-37-52 ~]# yum search python | grep -i mysql
Last metadata expiration check: 0:08:48 ago on Wed 14 Aug 2024 10:46:53 AM UTC.
python3-PyMySQL.noarch : Pure-Python MySQL client library   "I have copied this python3-PyMySQL  and added in the db.yaml file of Exercise -07"
python3.11-PyMySQL.noarch : Pure-Python MySQL client library
python3.11-PyMySQL+rsa.noarch : Metapackage for python3.11-PyMySQL: rsa extras
python3.12-PyMySQL.noarch : Pure-Python MySQL client library
python3.12-PyMySQL+rsa.noarch : Metapackage for python3.12-PyMySQL: rsa extras
[root@ip-172-31-37-52 ~]# exit
logout
[ec2-user@ip-172-31-37-52 ~]$ exit
logout
Connection to 172.31.37.52 closed.
ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-07$ vim db.yaml
---
- name: DBServers-Setup
  hosts: dbservers
  become: yes
  tasks:
    - name: Install mariadb-server
      ansible.builtin.yum:
        name: mariadb-server
        state: present

    - name: Install pymysql
      ansible.builtin.yum:
        name: python3-PyMySQL
        state: present

    - name: Start the mariaDB-server
      ansible.builtin.service:
        name: mariadb
        state: started
        enabled: yes

    - name: Create a new Database with name 'accounts'
      mysql_db:
        name: accounts
        state: present
        login_unix_socket: /var/lib/mysql/mysql.sock  
        #comment this above one line and rum the playbook we will get error and this because of socket file

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-07$ ansible-playbook -i inventory db.yaml

Again we will get a error and this of because of socket file

ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-07$ ansible-playbook -i inventory db.yaml


using community edition
before using the community edition we need to install  

ansible-galaxy collection install community.mysql


ubuntu@ip-172-31-34-26:~/vprofile-practice/exercise-07$ cat db.yaml
---
- name: DBServers-Setup
  hosts: dbservers
  become: yes
  tasks:
    - name: Install mariadb-server
      ansible.builtin.yum:
        name: mariadb-server
        state: present

    - name: Install pymysql
      ansible.builtin.yum:
        name: python3-PyMySQL
        state: present

    - name: Start the mariaDB-server
      ansible.builtin.service:
        name: mariadb
        state: started
        enabled: yes

    - name: Create a new Database with name 'accounts'
      community.mysql.mysql_db:
        name: accounts
        state: present
        login_unix_socket: /var/lib/mysql/mysql.sock

    - name: Create a database user with name 'vprofile'
      community.mysql.mysql_user:
        name: vprofile
        password: 'blueshark@123'
        priv: '*.*:ALL'
        state: present
        login_unix_socket: /var/lib/mysql/mysql.sock
